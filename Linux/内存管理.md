[TOC]





# 内存分配(malloc)

**简介**：分配虚拟内存，在第一次访问已分配虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，让后将两者关联起来。



## brk(<=128K)

![](appendix\brk.png)

![](appendix\brk_seg.png)



**简介**：将数据段（.data）的最高地址指针_edata往高地址推；

图7中free(B)之后， B对应的**虚拟内存**和**物理内存**都没有释放，但是**可以重新分配使用**；

图8中free(D)之后，BD形成140K空闲（**>128K**）触发**trim内存紧缩**操作；



## mmap/munmap(>128K)

![](appendix\mmap.png)



**简介**：在进程的虚拟地址空间中（堆和栈中间，称为文件映射区的地方）找一块空闲虚拟内存

> **mmap可以直接munmap释放为什么还需要brk？**
>
> 内存释放涉及到操作系统，频繁释放增加操作系统压力；





# Linux系统物理内存管理



**简介**：频繁地请求和释放不同大小的内存，必然导致内存碎片问题的产生，结果就是当再次要求分配连续的内存时，**即使整体内存是足够的，也无法满足连续内存的需求**

- 利用分页单元把一组非连续的空闲页框映射到连续的线性地址（类似于SGL）
- 开发一种适当的技术来记录现存的空闲的连续页框块的情况，以尽量避免为满足对小块的请求而分割大的空闲快（Buddy System）



## 伙伴系统（Buddy System）

**简介**：把所有的空闲页分组为11个链表，每个链表分别包含大小为1,2,4,8,16,32,64,128,256,512,1024个连续的页，（每页大小为4KB）



申请一个256个页的内存（1M）：

- 在256个页框的链表中检查是否有一个空闲快，如果**没有**，**查找下一个更大的块**，如果有，请求满足。
- 在512个页框的链表中检查是否有一个空闲块，如果**有**，把512个页框的空闲**块分为两份**，**第一份用于满足请求，第二份链接到256个页框的链表中。**如果没有空闲块，继续寻找下一个更大的块。



释放一个256个页的内存（1M）：

- 放入256的链表中，如果有**物理地址连续**的伙伴，则合并放入512的链表中，层层递归执行；



------

参考资料：

https://www.jianshu.com/p/c4ef33bde4f5